name: Setup NDK r27b

on:
  push:
    branches: [main]
  workflow_dispatch:  # 允许手动触发

jobs:
  setup-ndk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download and setup NDK r27b
      run: |
        # 1. 下载 NDK
        wget -q https://dl.google.com/android/repository/android-ndk-r27b-linux.zip
        
        # 2. 解压
        unzip -q android-ndk-r27b-linux.zip -d $RUNNER_TOOL_CACHE
        
        # 3. 设置环境变量
        NDK_PATH="$RUNNER_TOOL_CACHE/android-ndk-r27b"
        echo "NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
        
        # 4. 添加到 PATH
        echo "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Verify NDK clang versions
      run: |
        echo "=== NDK 交叉编译 clang 版本 ==="
        
        # 测试不同架构的编译器
        TOOLS_DIR="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
        
        # 使用 API level 21（最常用）
        echo "1. ARM64 (aarch64):"
        $TOOLS_DIR/aarch64-linux-android21-clang --version | head -1
        
        echo -e "\n2. ARM32 (armv7a):"
        $TOOLS_DIR/armv7a-linux-androideabi21-clang --version | head -1
        
        echo -e "\n3. x86_64:"
        $TOOLS_DIR/x86_64-linux-android21-clang --version | head -1
        
        echo -e "\n4. x86 (i686):"
        $TOOLS_DIR/i686-linux-android21-clang --version | head -1
        
        echo -e "\n=== 环境信息 ==="
        echo "NDK路径: $ANDROID_NDK_HOME"
        echo "工具链路径: $TOOLS_DIR"
        
        echo -e "\n=== 验证 PATH ==="
        which aarch64-linux-android21-clang